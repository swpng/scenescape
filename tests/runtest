#!/bin/bash

# SPDX-FileCopyrightText: (C) 2021 - 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

# If PROJECT is not set from the environment, fall back to a unique name
PROJECT=${PROJECT:-test$$}
# Cleanup mode: full (default) | keep_volumes | none
CLEANUP_MODE=${CLEANUP_MODE:-full}
SKIP_INIT=${SKIP_INIT:-0}

COMPOSE_FILES=$(echo $1 | sed -e 's/:/ /g')
shift

source $(dirname $(readlink -f $0))/../tools/yaml_parse.sh

# Remove the previous DBROOT directory before starting the new containers
if [ "${KEEP_DB}" != 1 ] ; then
    rm -rf $DBROOT
    mkdir -p $DBROOT
fi

COMPOSE_FLAGS=""
COMPOSE_DELETE=""
for COMPOSE in ${COMPOSE_FILES} ; do
    eval $(parse_yaml ${COMPOSE} COMPOSE_)
    NETWORK=${COMPOSE_networks}
    if [ -z "${NETWORK}" ] ; then
        parse_yaml ${COMPOSE} COMPOSE_
        echo Unable to parse network
        exit 1
    fi

    export DBROOT=${DBROOT:-$(dirname ${COMPOSE})}
    CTMP=$(mktemp --suffix=.yml ${PROJECT}-XXXXXX)

    IMAGE_BASE=${IMAGE%%:*}
    IMAGE_VERS=${IMAGE#*:}
    if [ -n "${IMAGE_VERS}" ] ; then
        IMAGE_VERS=":${IMAGE_VERS}"
    fi
    sed \
        -e "s|^image: scenescape\( *\|:[^ ]*\)*$|image: ${IMAGE_BASE}${IMAGE_VERS}|" \
        -e "/POSTGRES_\|CONTROLLER_AUTH/!s/${NETWORK}\(:\?\)$/${NETWORK}_${PROJECT}\1/" \
        ${COMPOSE} > ${CTMP}
    NETWORK="${NETWORK}_${PROJECT}"
    COMPOSE_FLAGS="${COMPOSE_FLAGS} -f ${CTMP}"
    COMPOSE_DELETE="${COMPOSE_DELETE} ${CTMP}"
done

source tests/test_utils.sh
if [ "${SKIP_INIT}" != "1" ]; then
  COMPOSE_PROJECT_NAME=${PROJECT} make init-sample-data install-models
else
  echo "Skipping init-sample-data/install-models because SKIP_INIT=1"
fi

docker compose ${COMPOSE_FLAGS} \
               --project-directory ${PWD} \
               --project-name ${PROJECT} \
               up -d --no-recreate

RUN_TEST=1

if [ -n "$WAITFORCONTAINERS" ]; then
    declare -a "container_config=($(echo $WAITFORCONTAINERS | tr '`$<>' '????'))"
    for conf in ${container_config[@]}; do
        IFS=":", read -ra container_args <<< ${conf}
        container=${container_args[0]}
        wait_text=${container_args[1]:-"Container is ready"}
        timeout=90

        if [ "${container}" = "pgserver" ]; then
            timeout=300
            wait_text="database system is ready to accept connections"
        fi

        if [ "${container}" = "broker" ]; then
            wait_text="mosquitto version .* running"
        fi

        if [ "${container}" = "autocalibration" ]; then
            timeout=600 # autocalibration needs time to download netvlad model weights
        fi

        echo Waiting ${timeout} seconds for ${container}
        if ! wait_for_container "${PROJECT}-${container}-1" "${wait_text}" "${timeout}"; then
            RUN_TEST=0
            break
        fi
        echo ${container} took ${CUR_WAIT} to be ready
    done
fi

if [ "${RUN_TEST}" = 1 ] ; then
    if [[ "${IMAGE}" == *scenescape-controller-test* ]]; then
        CMD="$@"
    else
        CMD="PYTHONPATH=/home/scenescape/SceneScape/ $@"
    fi

    tools/scenescape-start --image ${IMAGE} --network ${PROJECT}_${NETWORK} --project ${PROJECT} ${CMD}
    STATUS=$?
else
    STATUS=3
fi

if [ -n "$LOGSFORCONTAINER" ] ; then
    for container in ${LOGSFORCONTAINER}; do
        echo
        echo '---------------------------------'
        echo "docker logs ${PROJECT}-$container"
        LOG_CMD="docker logs ${PROJECT}-${container}-1 2>&1 | sed -e 's/^/${container} /'"
        if [ -n ${LOG} ] ; then
            LOG_CMD+="| tee -a ${LOG}"
        fi
        eval "${LOG_CMD}"
    done
fi

for container in $(docker ps | grep ${PROJECT} | awk '{print $NF}'); do
    TRACEFOUND=$(docker logs ${container} 2>&1 | grep "Traceback" -c)
    if [[ $TRACEFOUND -ne 0 ]]; then
        echo "Found Traceback in ${container}!"
        if [[ -n ${LOG} ]]
        then
            docker logs ${container} | tee -a ${LOG}
        else
            docker logs ${container}
        fi
    fi
done

case "${CLEANUP_MODE}" in
  keep_volumes)
    # stop containers & remove network, but keep named volumes (DB, migrations, sample-data)
    docker compose ${COMPOSE_FLAGS} --project-directory ${PWD} --project-name ${PROJECT} down
    ;;
  none)
    # don't touch containers or volumes
    ;;
  *)
    # default: full cleanup, including volumes
    docker compose ${COMPOSE_FLAGS} --project-directory ${PWD} --project-name ${PROJECT} down -v
    # Remove any existing database and migration volumes for this project to ensure clean state
    docker volume rm -f ${PROJECT}_vol-models ${PROJECT}_vol-db ${PROJECT}_vol-migrations ${PROJECT}_vol-sample-data ${PROJECT}_vol-media 2>/dev/null || true
    ;;
esac

docker system prune -f
rm -f ${COMPOSE_DELETE}

exit $STATUS
